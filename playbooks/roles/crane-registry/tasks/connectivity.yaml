---
# Check if worker nodes can reach the crane registry
- name: Test registry accessibility from worker nodes
  command: >
    oc debug node/{{ item }} -- chroot /host
    curl -s --connect-timeout {{ crane_test_timeout }}
    http://{{ crane_registry_addr }}/v2/_catalog
  register: registry_access_test
  ignore_errors: yes
  loop: "{{ groups['worker'] }}"
  run_once: true
  changed_when: false

- name: Determine registry accessibility
  set_fact:
    crane_registry_accessible: >-
      {{ registry_access_test.results | map(attribute='rc') | min == 0 }}

- name: Show registry accessibility result
  debug:
    msg: "Crane registry reachable from workers: {{ crane_registry_accessible }}"

# CONDITIONAL FIXES (ONLY RUN IF NOT ACCESSIBLE)
- name: Open firewall port on bastion
  firewalld:
    port: "{{ crane_port }}/tcp"
    permanent: true
    state: enabled
    zone: "{{ crane_firewall_zone }}"
  when: not crane_registry_accessible

- name: Reload firewalld
  command: firewall-cmd --reload
  when: not crane_registry_accessible

- name: Patch OpenShift to mark registry as insecure
  command: >
    oc patch image.config.openshift.io/cluster
    --type=merge
    -p
    '{"spec":{"registrySources":{"insecureRegistries":["{{ crane_registry_addr }}"]}}}'
  when: not crane_registry_accessible