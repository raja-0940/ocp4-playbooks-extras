# Environment variables check block

- set_fact:
    github_username: "{{ lookup('ansible.builtin.env','GITHUB_USERNAME') }}"
    github_personal_access_token: "{{ lookup('ansible.builtin.env','GITHUB_ACCESS_TOKEN') }}"

- fail:
    msg: "Please set eco_gotests_repo variable with the e2e repo URL."
  when: eco_gotests_repo == "" or eco_gotests_repo == None

# Cluster health check
- name: Invoke the role check-cluster-health to check cluster status
  include_role:
    name: check-cluster-health

# openshift-test-private e2e run block
- name: Validate eco
  block:
    - fail:
        msg: "Please set the environment variables GITHUB_USERNAME and GITHUB_ACCESS_TOKEN"
      when: github_username == "" and github_personal_access_token == ""

    - name: Include role for installation of Go lang
      include_role:
        name: golang-installation
      vars:
        go_tarball: "{{ golang_tarball_url }}"
        golang_path: "/usr/local"

    - name: Set Go environment facts
      set_fact:
        go_root: "/usr/local/go"
        go_path: "/root/go"
        go_bin: "/root/go/bin"

    - name: Ensure eco-gotests directory exists
      git:
        repo: https://github.com/openshift-kni/eco-gotests.git
        dest: /tmp/eco-gotests
        version: main
        
    - name: Ginkgo installation
      shell: |
        export GOROOT={{ go_root }}
        export GOPATH={{ go_path }}
        export PATH=$PATH:{{ go_root }}/bin:{{ go_bin }}
        go install github.com/onsi/ginkgo/v2/ginkgo@v2.23.4
      args:
        executable: /bin/bash
      environment:
        GOROOT: "{{ go_root }}"
        GOPATH: "{{ go_path }}"
        PATH: "{{ ansible_env.PATH }}:{{ go_root }}/bin:{{ go_bin }}"

    - name: Verify ginkgo installation
      command: "{{ go_bin }}/ginkgo version"
      register: ginkgo_version
      changed_when: false

    - name: Display ginkgo version
      debug:
        msg: "Ginkgo installed successfully: {{ ginkgo_version.stdout }}"

    - name: Symlink ginkgo binary to /usr/local/bin
      file:
        src: "{{ go_bin }}/ginkgo"
        dest: /usr/local/bin/ginkgo
        state: link

    - name: Install local container registry ( Crane registry )
      include_role:
        name: crane-registry

    - name: Add the following nameservers in /etc/resolv.conf
      lineinfile:
        path: /etc/resolv.conf
        line: "{{ item }}"
        state: present
        insertafter: EOF
        create: no
      loop:
        - "nameserver 10.0.10.4"
        - "nameserver 10.0.10.5"
      become: yes

    - name: Configure local registry as insecure
      copy:
        dest: /etc/containers/registries.conf.d/local-crane.conf
        content: |
          [[registry]]
          location = "{{ crane_registry_addr }}"
          insecure = true

    - name: Check crane registry is reachable
      command: >
        curl -s -k http://{{ crane_registry_addr }}/v2/_catalog
      register: crane_registry_catalog
      changed_when: false      

    - name: Show crane registry catalog
      debug:
        msg: "Crane registry reachable. Catalog: {{ crane_registry_catalog.stdout }}"

    - name: Build oc-dummy-device-plugin image for KMM tests
      include_role:
        name: device-plugin-image-build

    - name: Install KMM operator
      include_role:
        name: ocp-kmm

    - name: Wait for KMM operator to be available
      shell: |
        oc wait deployment/kmm-operator-controller -n openshift-kmm --for=condition=Available --timeout=300s
      args:
        executable: /bin/bash

    - name: Set KMM environment variables for eco-gotests
      set_fact:
        kmm_test_env:
          GLOG_v: "101"
          KUBECONFIG: "/root/.kube/config"
          ECO_HWACCEL_KMM_REGISTRY: "{{ crane_registry_addr }}/{{ pdp_registry_namespace }}"
          ECO_TEST_FEATURES: "modules"
          ECO_TEST_LABELS: "KMM"
          ECO_HWACCEL_KMM_SUBSCRIPTION_NAME: "kernel-module-management"
          ECO_HWACCEL_KMM_UPGRADE_TARGET_VERSION: "2.5.1"
          ECO_HWACCEL_KMM_CATALOG_SOURCE_NAME: "redhat-operators"
          ECO_HWACCEL_KMM_PULL_SECRET: "TOKEN"
          ECO_HWACCEL_KMM_SERVICEACCOUNT: "kmm-helper-sa"
          ECO_HWACCEL_KMM_DEVICE_PLUGIN_IMAGE: >
            "{{ crane_registry_addr }}/{{ pdp_registry_namespace }}/{{ pdp_image_name }}:{{ pdp_image_tag }}"

    - name: Show KMM environment variables
      debug:
        var: kmm_test_env

    - name: Run KMM Ginkgo tests with full logs
      shell: |
        set -o pipefail
        ginkgo -vv ./tests/hw-accel/kmm/modules -- -v=90 2>&1 | tee ~/all-kmm-tests-$(date +%d%m%y).log
      args:
        chdir: "{{ eco_gotests_directory }}"
        executable: /bin/bash
      environment: "{{ kmm_test_env }}"